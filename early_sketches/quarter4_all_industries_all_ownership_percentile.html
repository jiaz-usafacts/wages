<!DOCTYPE html>
<meta charset="utf-8">

<!-- Load d3.js -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,500;0,600;1,300&display=swap" rel="stylesheet">
<script src="https://d3js.org/d3.v6.js"></script>
<script src="stateFipsDict.js"></script>
<script src="colorScale.js"></script>
<script src="https://unpkg.com/d3-scale-cluster@1.3.1/dist/d3-scale-cluster.min.js"></script>
<style>
	body{
		font-size:12px;
		font-family: 'Open Sans', sans-serif;
		font-weight:100;
	}
	p{
		width:400px;
	}
	#popup{
		position:fixed;
		background-color:rgba(255,255,255,.8);
		border:1px solid black;
		font-size:11px;
		padding:10px;
		display:none;
		z-index:3;
	}
	#key{
		font-size:12px;
		margin:10px;
		width:400px;
		height:100px;
	}
	
#info{
	width:100%;
	z-index:2;
	padding:10px;
}
#charts{
	z-index:1;
	font-size:12px;
}
.quarter{
	width:800px;
}
.qButton{
	display:inline-block;
	width:120px;
	border:1px solid black;
	padding:3px;
	text-align:center;
	cursor:pointer;
}
#quarterControl{
	font-size:12px;
}	
.smallMap{
	display:inline-block;
}

#activeColumn{
	font-size:18px;
}
.button{
	width:250px;
	height:60px;
	border:1px solid black;
	padding:5px;
	margin:5px;
	vertical-align:top;
	display:inline-block;
	cursor:pointer;
}
</style>
<!-- Create an element where the map will take place -->
<div id="info">
	<div id="activeColumn"></div>
</div>
	<!-- <div id="key"></div> -->

<div id="popup"></div>
<div id="charts">
</div>

<script>
	
	var colorByColumn = "oty_avg_wkly_wage_pct"
	var colorByColumn2 = "oty_avg_wkly_wage_pct_chg"
	
	
	var aboveColor = "#00906E"
	var belowColor = "#D99522"
	
	
	var geoidsInMap;
	
	var root = "data_processed_quarterly_industry/"
	var file = "10 Total, all industries_own0.json"
	
	//var nationFile = "10 Total, all industries_agg10_own5_quarter4.json"
	var nationFile = "10 Total, all industries_agg10_own0_quarter4.json"
	
	d3.select("#activeColumn").html(colorByColumn+"<br>"+root+file)
	
// Load external data and boot
Promise.all([d3.json("mainland.geojson"),d3.json(root+file),d3.json(root+nationFile)])
  .then(function(loadData){
	  
	  
		  	var mapData = loadData[0]
	  
		  	var quarterlyData = loadData[1]
	  var nationData = loadData[2]
	  
	  var nationAveragesByYearQuarter = makeNationalAverageDict(nationData["US000"])
	
	
  var clusterInput = []
	  
	  for(var y = 1990; y<=2010; y++){
		  var quarter = 4
  	      var clusterInputResults = getClusterInput(quarterlyData,y+"_"+quarter,clusterInput)
	  
	  }
	
	  for(var y = 2010; y<=2021; y++){
		  var quarter = 4
		  var step = 10
		  var domain=[]
		  var avg = nationAveragesByYearQuarter[y+"_"+quarter][colorByColumn]
		  if(avg==undefined){
			  var avg = nationAveragesByYearQuarter[y+"_"+quarter][colorByColumn2]
		  }
		  // for(var s =-1; s<=1; s++){
  // 		  	//console.log(s)
  // 			 domain.push(avg+s*step)
  // 		  }
  // 		  console.log(domain)
  
	var colors = ["#CC6A19","#D99522","#E5BD3F","#F2E289","#F1F1F1","#97DFC7","#5CB79A","#00906E","#004837"]
		
		  var cScale = d3.scaleCluster()
		  .domain(clusterInputResults)
		  .range(colors)
  
  		drawMap(quarterlyData, mapData,y+"_"+quarter,avg,cScale)
  //break
	  }	  
	  
	  drawScale()
})
function getClusterInput(data,yearQuarter,list){
	
	for(i in data){
		//console.log(data[i][yearQuarter])
		if(data[i][yearQuarter]!=undefined){
			var value = data[i][yearQuarter][colorByColumn2]
			if(value ==undefined){
				var value = data[i][yearQuarter][colorByColumn]
			}
			value = parseFloat(value)
			if(list.indexOf(value)==-1){
				list.push(value)
			}
			
		}
		
	}
	return list
}


function makeNationalAverageDict(nationData){
	var formatted = {}
	for(var y in nationData){
		//console.log(y)
		formatted[y]=nationData[y]
	}
	return formatted
}

function drawScale(){
	var w = 240
	var h = 60
	var p = 20
	var bh = 20
	var bw = 20
	var svg = d3.select("#key").append("svg").attr("width",w).attr("height",h)
	svg.append("rect").attr("width",bw).attr("height",bh).attr("x",bw).attr("y",0).attr("fill",aboveColor)
	svg.append("rect").attr("width",bw).attr("height",bh).attr("x",bw).attr("y",bh+2).attr("fill",belowColor)
	
	svg.append("text").attr("x",bw*2+2).attr("y",bh-2).attr("fill",aboveColor).text("Above national pct change")
	svg.append("text").attr("x",bw*2+2).attr("y",bh*2-2).attr("fill",belowColor).text("Below national pct change")
	
}
function sortByYear(data,yearQuarter){
	var list = []
	
	for(i in data){
		//console.log(data[i][yearQuarter])
		if(data[i][yearQuarter]!=undefined){
			var value = data[i][yearQuarter][colorByColumn2]
			if(value ==undefined){
				var value = data[i][yearQuarter][colorByColumn]
			}
			value = parseFloat(value)
			list.push({gid:i,value:value})
		}
	}
	
	var sorted = list.sort(function(a,b){
		return a.value-b.value
	})
	
	var sortedGids = []
	var sortedValues = []
	for(var j in sorted){
		sortedGids.push(sorted[j].gid)
		if(sortedValues.indexOf(sorted[j].value)==-1){
			sortedValues.push(sorted[j].value)
			
		}
	}
	return [sortedGids,sortedValues]
}

function calculateAboveBelow(data,threshold,divName){
	var above = []
	var below = []
	var decrease = []
	for(var i in data){
		var wagePctIncrease = parseFloat(data[i]["oty_avg_wkly_wage_pct_chg"])
		if(wagePctIncrease>=parseFloat(threshold)){
			above.push(data[i]["fips"])
		}else if(wagePctIncrease>=0){
			below.push(data[i]["fips"])
		}else{
			decrease.push(data[i]["fips"])
		}
	}
	d3.select("#"+divName).attr("class","explaination")
	.html("In quarter "+currentQuarter.replace("q","")+", with inflation at "+inflation+"%, "+above.length+" counties had average wage increases that were equalt to or above inflation, while "
	+below.length+" counties had wages increases that were less than inflation, and "+decrease.length+" counties had lower average weekly wages.")
}

function formatByFips(data){
	var formatted = {}
	for(var i in data){
		var cData = data[i]
		var fips = cData["area_fips"]
		formatted[fips]=cData
	}
	return formatted
}

function drawMap(data, mapData,divName, nationAvg,clusterScale){	
	//console.log(data)
	var sortedGids = sortByYear(data,divName)
	  var w = 200
	  var h = 150
	var p = 10
	const div = d3.select("#charts").append("div").attr("id",divName).attr("class","smallMap")
	var svg = div.append("svg")
	  .attr("width",w)
	  .attr("height",h+p)
	
	svg.append("text").text(divName.replace("_"," q")).attr("x",10).attr("y",10).style("font-size","12px")
	svg.append("text").text("national avg: "+nationAvg).attr("x",10).attr("y",20).style("font-size","12px")
	
	
	// Map and projection
	const path = d3.geoPath();
	const projection = d3.geoMercator()
		.fitSize([w,h],mapData);

		  
  svg.append("g")
    .selectAll("path")
    .data(mapData.features)
    .join("path")
      // draw each country
      .attr("d", d3.geoPath()
        .projection(projection)
      )
  	.attr("class", function(d){
  		var state = "path_state_"+d.properties["STATE"]
  		//console.log(d.properties)
  		return "countyPath "+state
  	})
	.attr("quarter",divName)
      // set the color of each country
      .attr("fill", function (d) {
		  var fips = d.properties["GEO_ID"].split("US")[1]
		  var countyData = data[fips][divName]
		  var fipsIndex = sortedGids.indexOf(fips)
		  //console.log(fipsIndex)
		  
		 
		  
		  if(countyData!=undefined){
		  			  if(countyData[colorByColumn]!=undefined){
		  		  		  var value = parseFloat(countyData[colorByColumn])
		  			  }else{
		  		  		  var value = parseFloat(countyData[colorByColumn2])
		  			  }
					  return clusterScale(value)
		   		 
		  		  }
		  
	//var colors = ["#CC6A19","#D99522","#E5BD3F","#F2E289","#F1F1F1","#97DFC7","#5CB79A","#00906E","#004837"]
		  
		  // var totalLength = sortedGids.length
 // 		  if(fipsIndex>totalLength*.75){
 // 		  	return "#E5BD3F"
 // 		  }else if(fipsIndex>totalLength*.5){
 // 		  	return "#F2E289"
 // 		  }else if(fipsIndex>totalLength*.25){
 // 		  	return "#97DFC7"
 // 		  }else{
 // 		  	return "#5CB79A"
 // 		  }
		  		  //
		  // var cScale = d3.scaleLinear().domain([0,sortedGids.length/2,sortedGids.length]).range([belowColor,"white",aboveColor])
		  // return cScale(fipsIndex)
		  
			   // if(fipsIndex >= sortedGids.length/2){
   // 	  			  	return aboveColor
   // 	   			  }else{
   // 	   			  	return belowColor
   // 	   			  }
	  //
	})
	.attr("cursor","pointer")
	 .attr("stroke","#000")
	 .attr("stroke-opacity",0)
	.attr("id",function(d){
		var fips = d.properties["GEO_ID"].split("US")[1]
		return "_"+fips
	})	
	.on("click",function(e,d){
		var fips = d.properties["GEO_ID"].split("US")[1]
		var pctChg = parseFloat(quarterData[currentQuarter][fips][colorByColumn])
		inflation = pctChg
		recolorForNewInflation()
		//console.log(pctChg)
		
	})
	.on("mouseover",function(e,d){
		//console.log(d)
		d3.select(this).style("stroke-opacity",1)
		var county = d.properties.NAME
		var stateName = numberToState[d.properties.STATE]
		var fips = d.properties["GEO_ID"].split("US")[1]
		var popupString = county+" County, "+stateName
		
		var state = "state_"+d.properties["STATE"]

		var dataString = ""
		if(data[fips]!=undefined){
			var countyData = data[fips][divName]
			for(var c in countyData){
					dataString+=c+": "+countyData[c]+"<br>"
			}
			
		}
		
		popupString+=dataString

	    var posX = e.clientX;
	    var posY = e.clientY;
		
		
		d3.select("#popup").html(popupString)
		.style("left",posX+20+"px")
		.style("top",posY+"px")
		.style("display","block")
		
		d3.selectAll(".countyDot").attr("opacity",0)
		d3.selectAll(".dot_"+state).attr("opacity",.2)
		d3.selectAll("#_"+fips).attr("opacity",1)
		
		//console.log(state)
		d3.selectAll("#"+state).attr("stroke-opacity",.2)
		
	})
	.on("mouseout",function(e,d){
		d3.select(this).style("stroke-opacity",0)
		d3.selectAll(".countyDot").attr("opacity",1)
		d3.selectAll(".countyPath").attr("stroke-opacity",0)
		
		d3.selectAll(".statePath").attr("stroke-opacity",0)
		d3.select("#popup").style("display","none")
		d3.selectAll("#stateLabel").text("All counties")
		
	})
	

}



</script>